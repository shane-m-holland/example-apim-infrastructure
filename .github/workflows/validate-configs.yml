# Example GitHub Actions Workflow for Infrastructure Repository  
# Copy this file to your infrastructure repository at: .github/workflows/validate-configs.yml

name: Validate Environment Configurations

permissions:
  contents: read         # Read repository contents
  issues: write          # Comment on issues
  pull-requests: write   # Comment on pull requests

on:
  # Validate on pull requests to catch issues early
  pull_request:
    paths:
      - 'environments/**'
      - '.github/workflows/**'
      
  # Validate on pushes to main branch
  push:
    branches: [main]
    paths:
      - 'environments/**'
      
  # Allow manual validation
  workflow_dispatch:
    inputs:
      environment:
        description: 'Specific environment to validate (leave empty for all)'
        type: string
        default: ''
      validate_azure_resources:
        description: 'Validate Azure resources accessibility'
        type: boolean
        default: false

jobs:
  determine-scope:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.scope.outputs.environment }}
    steps:
    - name: Determine validation scope
      id: scope
      run: |
        if [[ "${{ inputs.environment }}" != "" ]]; then
          echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
        else
          echo "environment=all" >> $GITHUB_OUTPUT
        fi

  validate-configurations:
    needs: determine-scope
    uses: shane-m-holland/azure-apim-bicep/.github/workflows/validate-config.yml@v1
    with:
      environment: ${{ needs.determine-scope.outputs.environment }}
      config-repo: ${{ github.repository }}
      validate-azure-resources: ${{ inputs.validate_azure_resources || false }}
      infra-only-validation: true
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
    #   CONFIG_REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  comment-on-pr:
    needs: [determine-scope, validate-configurations]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - name: Comment on PR (if validation fails)
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      continue-on-error: true  # Don't fail workflow if commenting fails
      with:
        script: |
          try {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **Configuration validation failed**\n\nPlease check the workflow logs and fix the configuration issues before merging.\n\n[View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            });
            console.log('✅ PR comment posted successfully');
          } catch (error) {
            console.log('⚠️ Failed to post PR comment:', error.message);
            console.log('This may be due to insufficient permissions or repository settings.');
          }
          
    - name: Comment on PR (if validation succeeds)
      if: success() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      continue-on-error: true  # Don't fail workflow if commenting fails
      with:
        script: |
          try {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ **Configuration validation passed**\n\nAll environment configurations are valid and ready for deployment.\n\n[View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            });
            console.log('✅ PR comment posted successfully');
          } catch (error) {
            console.log('⚠️ Failed to post PR comment:', error.message);
            console.log('This may be due to insufficient permissions or repository settings.');
          }